name: Download MEXC APK and Release

on:
  workflow_dispatch:

jobs:
  download-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4   

      - name: Install apkeep via Cargo
        uses: baptiste0928/cargo-install@v3
        with:
          crate: apkeep
          git: https://github.com/EFForg/apkeep.git   

      - name: Download
        id: artifact
        run: |
          apkeep -a com.mexcpro.client .
          FILE="com.mexcpro.client.xapk"
          if [ ! -f "$FILE" ]; then
            echo "Download failed or file not found: $FILE"
            ls -la
            exit 1
          fi
          echo "file=$FILE" >> "$GITHUB_OUTPUT"
          echo "Found and verified asset: $FILE"
      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="mexc-apk-$(date +%Y%m%d)"
          gh release create "$TAG" \
            "${{ steps.artifact.outputs.file }}" \
            --title "MEXC APK $TAG" \
            --notes "Latest asset for com.mexcpro.client downloaded via apkeep."
