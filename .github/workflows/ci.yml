name: Download MEXC APK and Release

on:
  workflow_dispatch:

jobs:
  download-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4   

      - name: Install apkeep via Cargo
        uses: baptiste0928/cargo-install@v3
        with:
          crate: apkeep
          git: https://github.com/EFForg/apkeep.git   

      - name: Download XAPK and Extract Version
        id: download
        run: |
          # Download the latest MEXC XAPK
          apkeep -a com.mexcpro.client --metadata-output metadata.json .
          FILE="com.mexcpro.client.xapk"

          if [ ! -f "$FILE" ]; then
            echo "Download failed or file not found: $FILE"
            ls -la
            exit 1
          fi

          # Extract versionName from metadata.json
          VERSION=$(jq -r '.versionName' metadata.json)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Downloaded version: $VERSION"
          echo "xapk=$FILE" >> "$GITHUB_OUTPUT"

      - name: Repack Selected APKs into APKS
        id: repack
        run: |
          mkdir extracted
          unzip -q "${{ steps.download.outputs.xapk }}" -d extracted

          cd extracted
          mkdir selected

          # Copy and rename files
          cp com.mexcpro.client.apk selected/base.apk || echo "base APK missing!"
          cp config.arm64_v8a.apk selected/split_config.arm64_v8a.apk || echo "arm64 split missing!"
          cp config.xxhdpi.apk selected/split_config.xxhdpi.apk || echo "xxhdpi split missing!"

          cd selected

          # Repack into .apks with max compression (-9)
          zip -r9 ../../MEXC-Pro_${{ steps.download.outputs.version }}-arm64_v8a.apks ./*
          cd ../..

          echo "apks=MEXC-Pro_${{ steps.download.outputs.version }}-arm64_v8a.apks" >> "$GITHUB_OUTPUT"
          echo "Created: MEXC-Pro_${{ steps.download.outputs.version }}-arm64_v8a.apks"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.download.outputs.version }}
          name: MEXC APK Release ${{ steps.download.outputs.version }}
          body: "Repacked .xapk â†’ .apks for Obtainium.\n\nIncludes: base.apk, split_config.arm64_v8a.apk, split_config.xxhdpi.apk"
          files: ${{ steps.repack.outputs.apks }}
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
