name: Download MEXC APK and Release

on:
  workflow_dispatch:

jobs:
  download-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4   

      - name: Install apkeep via Cargo
        uses: baptiste0928/cargo-install@v3
        with:
          crate: apkeep
          git: https://github.com/EFForg/apkeep.git   

      - name: Get Latest Version and Download XAPK
        id: download
        run: |
          # Step 1: Get latest version from APKPure
          LATEST_VERSION=$(apkeep -l -a com.mexcpro.client | head -n 1 | grep -oE '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+')
          
          if [ -z "$LATEST_VERSION" ]; then
            echo "Failed to retrieve latest version"
            exit 1
          fi

          echo "Latest version: $LATEST_VERSION"

          # Step 2: Download specific version as XAPK
          apkeep -a "com.mexcpro.client@$LATEST_VERSION" .

          XAPK_FILE="com.mexcpro.client.xapk"

          if [ ! -f "$XAPK_FILE" ]; then
            echo "Download failed: $XAPK_FILE not found"
            ls -la
            exit 1
          fi

          # Output values
          echo "version=$LATEST_VERSION" >> "$GITHUB_OUTPUT"
          echo "xapk=$XAPK_FILE" >> "$GITHUB_OUTPUT"
          echo "Downloaded: $XAPK_FILE (version $LATEST_VERSION)"

      - name: Repack Selected APKs into APKS
        id: repack
        run: |
          XAPK="${{ steps.download.outputs.xapk }}"
          VERSION="${{ steps.download.outputs.version }}"

          mkdir extracted
          unzip -q "$XAPK" -d extracted

          cd extracted
          mkdir selected

          # Copy required splits (fail gracefully if missing)
          cp com.mexcpro.client.apk selected/base.apk || { echo "base.apk missing!"; exit 1; }
          cp config.arm64_v8a.apk selected/split_config.arm64_v8a.apk || echo "arm64 split missing"
          cp config.xxhdpi.apk selected/split_config.xxhdpi.apk || echo "xxhdpi split missing"

          cd selected

          # Create .apks file
          APKS_FILE="../../MEXC-Pro_${VERSION}-arm64_v8a.apks"
          zip -r9 "$APKS_FILE" ./*

          cd ../..
          echo "apks=MEXC-Pro_${VERSION}-arm64_v8a.apks" >> "$GITHUB_OUTPUT"
          echo "Created: MEXC-Pro_${VERSION}-arm64_v8a.apks"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.download.outputs.version }}
          name: MEXC Pro ${{ steps.download.outputs.version }}
          body: |
            Repacked `.xapk` â†’ `.apks` for **Obtainium**.

            Includes:
            - `base.apk`
            - `split_config.arm64_v8a.apk`
            - `split_config.xxhdpi.apk`

            **Source:** APKPure
          files: ${{ steps.repack.outputs.apks }}
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Use built-in token or PAT
