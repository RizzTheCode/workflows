name: Download MEXC APK and Release

on:
  workflow_dispatch:

jobs:
  download-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install apkeep via Cargo
        uses: baptiste0928/cargo-install@v3
        with:
          crate: apkeep
          git: https://github.com/EFForg/apkeep.git

      - name: Download APK (or XAPK)
        run: |
          apkeep -a com.mexcpro.client .

      - name: Locate downloaded file
        id: artifact
        run: |
          FILE=$(find . -maxdepth 1 -type f ( -name '*.apk' -o -name '*.xapk' -o -name '*.apks' ) | head -n 1)
          if [ -z "$FILE" ]; then
            echo "No APK/XAPK/APKS file found"; exit 1;
          fi
          echo "file=$FILE" >> "$GITHUB_OUTPUT"
          echo "Found asset: $FILE"

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="mexc-apk-$(date +%Y%m%d)"
          gh release create "$TAG" \
            "${{ steps.artifact.outputs.file }}" \
            --title "MEXC APK $TAG" \
            --notes "Latest asset for com.mexcpro.client downloaded via apkeep."
