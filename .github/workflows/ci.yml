name: Download MEXC APK and Release

on:
  workflow_dispatch:

jobs:
  download-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install apkeep via Cargo
        uses: baptiste0928/cargo-install@v3
        with:
          crate: apkeep
          git: https://github.com/EFForg/apkeep.git

      - name: Download XAPK
        id: download
        run: |
          apkeep -a com.mexcpro.client .
          FILE="com.mexcpro.client.xapk"
          if [ ! -f "$FILE" ]; then
            echo "Download failed or file not found: $FILE"
            ls -la
            exit 1
          fi
          echo "xapk=$FILE" >> "$GITHUB_OUTPUT"
          echo "Downloaded: $FILE"

      - name: Repack XAPK into APKS
        id: repack
        run: |
          mkdir extracted
          unzip "${{ steps.download.outputs.xapk }}" -d extracted

          cd extracted
          ls
          mkdir selected
          cp base.apk selected/ || echo "base.apk not found"
          cp split_config.arm64_v8a.apk selected/ || echo "arm64_v8a split not found"
          cp split_config.xxhdpi.apk selected/ || echo "xxhdpi split not found"

          cd selected
          zip -r ../../MEXC-latest.apks ./*
          cd ../..

          echo "apks=MEXC-latest.apks" >> "$GITHUB_OUTPUT"
          echo "Created: MEXC-latest.apks"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.run_number }}
          name: MEXC APK Release $(date +%Y%m%d)
          body: "Repacked .xapk â†’ .apks for Obtainium."
          files: ${{ steps.repack.outputs.apks }}
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
