name: Download MEXC APK and Release

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'  # Optional: Run daily at 3 AM UTC

jobs:
  download-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for creating releases

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install apkeep via Cargo
        uses: baptiste0928/cargo-install@v3
        with:
          crate: apkeep
          git: https://github.com/EFForg/apkeep.git

      - name: Get Latest Version and Download XAPK
        id: download
        run: |
          echo "Fetching latest MEXC version from APKPure..."

          # Get latest version quietly (suppress progress bars, colors, stderr)
          LATEST_VERSION=$( \
            apkeep -l -a com.mexcpro.client 2>/dev/null \
            | head -n 5 \
            | grep -m1 -oE '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+' \
          )

          if [ -z "$LATEST_VERSION" ]; then
            echo "Failed to retrieve latest version. APKPure may be rate-limited or down."
            exit 1
          fi

          echo "Latest version: $LATEST_VERSION"

          # Download specific version as XAPK (suppress output to avoid broken pipe)
          echo "Downloading com.mexcpro.client@$LATEST_VERSION..."
          apkeep -a "com.mexcpro.client@$LATEST_VERSION" . >/dev/null 2>&1

          XAPK_FILE="com.mexcpro.client.xapk"

          if [ ! -f "$XAPK_FILE" ]; then
            echo "Download failed: $XAPK_FILE not found"
            ls -la
            exit 1
          fi

          # Output for next steps
          echo "version=$LATEST_VERSION" >> "$GITHUB_OUTPUT"
          echo "xapk=$XAPK_FILE" >> "$GITHUB_OUTPUT"
          echo "Downloaded: $XAPK_FILE (version $LATEST_VERSION)"

      - name: Repack Selected APKs into APKS
        id: repack
        run: |
          XAPK="${{ steps.download.outputs.xapk }}"
          VERSION="${{ steps.download.outputs.version }}"

          echo "Extracting $XAPK..."
          mkdir extracted
          unzip -q "$XAPK" -d extracted

          cd extracted
          mkdir selected

          # Required files
          cp com.mexcpro.client.apk selected/base.apk || { echo "base.apk missing!"; exit 1; }
          cp config.arm64_v8a.apk selected/split_config.arm64_v8a.apk || echo "arm64_v8a split missing"
          cp config.xxhdpi.apk selected/split_config.xxhdpi.apk || echo "xxhdpi split missing"

          cd selected

          APKS_FILE="../../MEXC-Pro_${VERSION}-arm64_v8a.apks"
          echo "Repacking into $APKS_FILE..."
          zip -r9 "$APKS_FILE" ./*

          cd ../..
          echo "apks=MEXC-Pro_${VERSION}-arm64_v8a.apks" >> "$GITHUB_OUTPUT"

      - name: Upload APKS as Artifact (Optional)
        uses: actions/upload-artifact@v4
        with:
          name: MEXC-Pro-${{ steps.download.outputs.version }}-arm64_v8a.apks
          path: MEXC-Pro_${{ steps.download.outputs.version }}-arm64_v8a.apks

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.download.outputs.version }}
          name: MEXC Pro v${{ steps.download.outputs.version }}
          body: |
            **Repacked XAPK â†’ APKS for Obtainium**

            **App:** MEXC Pro (`com.mexcpro.client`)  
            **Version:** `${{ steps.download.outputs.version }}`  
            **Source:** [APKPure](https://apkpure.com)

            **Includes:**
            - `base.apk`
            - `split_config.arm64_v8a.apk`
            - `split_config.xxhdpi.apk`

            Use with **Obtainium** or **APKUpdater**.
          files: ${{ steps.repack.outputs.apks }}
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Built-in token with `contents: write`
