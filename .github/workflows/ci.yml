name: Download MEXC APK and Release

on:
  workflow_dispatch:

jobs:
  download-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4   

      - name: Install apkeep via Cargo
        uses: baptiste0928/cargo-install@v3
        with:
          crate: apkeep
          git: https://github.com/EFForg/apkeep.git   

      - name: Download and Rename APK
        id: artifact
        run: |
          apkeep -a com.mexcpro.client .
          FILE="com.mexcpro.client.xapk"
          if [ ! -f "$FILE" ]; then
            echo "Download failed or file not found: $FILE"
            ls -la
            exit 1
          fi
          
          # Rename file for Obtainium
          NEW_FILE="MEXC-latest.xapk"
          mv "$FILE" "$NEW_FILE"
          echo "file=$NEW_FILE" >> "$GITHUB_OUTPUT"
          echo "Renamed file to: $NEW_FILE"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.run_number }}
          name: MEXC APK Release $(date +%Y%m%d)
          body: "Automated release for Obtainium updates"
          files: ${{ steps.artifact.outputs.file }}
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
